<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stackium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * {
        --default-color: #39ff14;
        --interactable-color: #39ff14;
        }
    </style>
</head>

<body
    style="background-color: black; font-family: 'VT323', monospace; color: var(--default-color); font-size: 16pt; margin: 0; overflow: hidden;">
    <script type="module">
        import { h, Component, render } from 'https://cdn.skypack.dev/preact@10.13.0?min';
        import { useState } from 'https://cdn.skypack.dev/preact@10.13.0/hooks?min';
        import htm from 'https://cdn.skypack.dev/htm@3.1.1';
        import cytoscape from 'https://esm.sh/cytoscape@3.23.0';


        // Initialize htm with Preact
        const html = htm.bind(h);
        let refreshVariables = () => {};

        function sendCommand(command) {
            return fetch(window.location.href + "command", {
                method: "POST",
                body: command
            });
        }

        function DebuggerWindow(props) {
            const [isExpanded, setExpanded] = useState(props.expanded ?? true);
            return html`
                <fieldset style="border: 3px solid var(--default-color); flex-grow: ${ isExpanded ? 1 : 0}; margin: 5px;"><legend onClick=${() => setExpanded(!isExpanded)}>${props.title}</legend>${ isExpanded ? props.children : null}</fieldset>
            `;
        }

        function renderObjectToList(obj) {
            return Object.entries(obj).map(([key, value]) => html`<li>${key}: ${parseInt(value) ? '0x' + parseInt(value).toString(16) : value}</li>`);
        }

        function renderList(content) {
            return html`<ul style="list-style-type: \'* \'; columns: 2; margin: 0;">${content}</ul>`;
        }

        function MetaInfo() {
            const [pid, setPid] = useState(0);
            if (pid == 0) fetch(window.location.href + "pid").then(async (res) => {
                setPid(await res.text());
            });
            const [meta, setMeta] = useState({});
            if (Object.entries(meta).length == 0) sendCommand("debug_meta").then(async (res) => {
                setMeta(JSON.parse(await res.text()).DebugMeta)
            });
            return html`
                <${DebuggerWindow} title="Debugging ${pid}">
                ${renderList(renderObjectToList(meta))}
                </${DebuggerWindow}>
            `;
        }

        function renderButton(text, onClick) {
            return html`<button onClick=${onClick} style="border: 3px solid var(--interactable-color); color: var(--interactable-color); background-color: black; font: inherit;">${text}</button>`;
        }

        function renderSource(source) {
            if (source.error) {
                return renderList(renderObjectToList(source));
            } else {
                return source.CodeWindow.map((line) => html`<p style="margin: 0; ${line[2] ? 'color: white' : ''}"><span style="margin-right: 10px;">${line[0]}</span><span>${line[1]}</span></p>`);
            }
        }

        function BottomFlex(props) {
           return html`
           <contents style="display:flex;flex-direction:column;justify-content:space-between;height:100%;">
            ${props.children}
            </contents>
           `;
        }

        function SourceView() {
            const [source, setSource] = useState(null);
            sendCommand("src 5").then(async (res) => {
                setSource(renderSource(JSON.parse(await res.text())));
            });
            return html`
                <${DebuggerWindow} title="Source View">
                <${BottomFlex}>
                ${source}
                <buttons style="display:flex;justify-content: flex-end;">
                    ${renderButton("Continue", () => { sendCommand("continue"); refreshVariables() })}
                    ${renderButton("Step Out", () => { sendCommand("step_out"); refreshVariables() })}
                    ${renderButton("Step In", () => { sendCommand("step_in"); refreshVariables() })}
                    ${renderButton("Step Instruction", () => { sendCommand("step_instruction"); refreshVariables() })}
                </buttons>
                </${BottomFlex}>
                </${DebuggerWindow}>
                `;
        }

        function Registers() {
            const [registers, setRegisters] = useState({});
            sendCommand("get_registers").then(async (res) => {
                setRegisters(JSON.parse(await res.text()).Registers)
            });
            return html`
                <${DebuggerWindow} title="Registers" expanded=${false}>
                ${renderList(renderObjectToList(registers))}
                </${DebuggerWindow}>
            `;
        }

        function renderType(type) {
            let key = Object.keys(type)[0];
            if (key == 'Name') {
                return type[key];
            } else if (key == 'Ref') {
                return renderType(type[key]) + '*';
            } else {
                return `unsupported(${key})`
            }
        }

        function isRef(type) {
            return Object.keys(type)[0] == 'Ref';
        }

        function transformVariablesForCy(variables) {
            return [
                ...variables.map((variable) => {
                    return {
                        data: {
                            id: variable.addr,
                            label: variable.name,
                            type: renderType(variable.type_name),
                            value: variable.value,
                            text: `${variable.name}:\n ${renderType(variable.type_name)} = \n${parseInt(variable.value).toString(16)} @\n ${parseInt(variable.addr).toString(16)}`
                        },
                    }
                }),
                ...variables.filter((variable) => isRef(variable.type_name) && variables.some((v) => variable.value == v.addr)).map((variable) => {
                    return {
                        data: {
                            id: variable.addr + variable.value,
                            source: '' + variable.addr,
                            target: '' + variable.value
                        },
                    }
                })

            ];
        }

        function VariableView() {
            const [variables, setVariables] = useState({});
            const [rVV, rV] = useState(0);
            refreshVariables = () => {
                document.variablesDirty = true;
                rV(rVV + 1);
                console.log('requesting refresh');
            }
            if (Object.entries(variables) == 0 || document.variablesDirty) {
                console.log('refresh');
                sendCommand("read_variables").then(async (res) => {
                    setVariables(JSON.parse(await res.text()))
                });
                document.variablesDirty = false;
            }
            if (variables.Variables) {
                const container = document.getElementById('var_container');
                const cyVar = transformVariablesForCy(variables.Variables);
                console.log(cyVar);
                const graph = cytoscape({
                    elements: cyVar, container: container, style: [
                        {
                            selector: 'node',
                            style: {
                                'height': '100vh',
                                'width': '100vw',
                                'text-wrap': 'wrap',
                                'text-halign': 'center',
                                'text-valign': 'center',
                                'shape': 'rectangle',
                                'background-color': 'black',
                                'border-style': 'solid',
                                'border-width': '3px',
                                'color': '#39ff14',
                                'font-family': 'VT323, monospace',
                                'font-size': '16pt',
                                'border-color': '#39ff14',
                                'label': 'data(text)'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#39ff14',
                                'target-arrow-color': '#39ff14',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                            }
                        }
                    ]
                });
            }

            return html`
                <${DebuggerWindow} title="Variables" id="var_container">
                <div id="var_container" style="width: 100%; height: 100%"></div>
                </${DebuggerWindow}>
            `;
        }

        function InputLine(props) {
            const [value, setValue] = useState('');
            const updateText = (e) => {
                setValue(e.target.value);
            }
            return html`
                <div style="display: flex; flex-direction: row">
                    <p style="margin: 0; margin-right: 10px; font-size: 24pt;">${props.prefix}</p>
                    <input value=${value} onInput=${updateText} type="text" style="flex-grow: 1; border: 3px solid var(--interactable-color); color: var(--interactable-color); background-color: black; font: inherit;"/>
                    <button onClick=${() => props.onClick(value)} style="border: 3px solid var(--interactable-color); color: var(--interactable-color); background-color: black; font: inherit;">Send</button>
                </div>
            `;
        }

        function Breakpoints() {
            const [breakpoints, setBreakpoints] = useState([]);
            return html`
                <${DebuggerWindow} title="Breakpoints">
                <${BottomFlex}>
                ${renderList(breakpoints.map((breakpoint) => html`<p style="margin: 0;">${breakpoint}</p>`))}
                <${InputLine} prefix="Function: " onClick=${(value) => {
                    setBreakpoints([...breakpoints, value]);
                    sendCommand(`set_breakpoint ${value}`);
                }}/>
                </${BottomFlex}>
                </${DebuggerWindow}>
            `;
        }

        // Usage
        const App = html`
        <div style="display: flex; flex-flow: row; align-items: stretch; height: 100vh; width: 100vw; position: absolute;">
            <div style="display: flex; flex-flow: column; align-items: stretch; flex-grow: 2;" id="first">
                <${VariableView}/>
            </div>
            <div style="display: flex; flex-flow: column; align-items: stretch; flex-grow: 1;" id="second">
                <${Registers}/>
                <${Breakpoints}/>
                <${SourceView}/>
                <${MetaInfo}/>
            </div>
        </div>`;

        //new LeaderLine(document.querySelector('#first'), document.querySelector('#second'));

        // Renders: <div>My name is John Doe.</div>
        render(App, document.body);
    </script>
</body>

</html>